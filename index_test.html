<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>埼玉入試 英語リスニング単語トレーナー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f4f4;
    }
    .container {
      max-width: 520px;
      margin: 0 auto;
      background: #fff;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 8px;
    }
    .subtitle {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 12px;
    }
    .status {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 4px;
    }
    .card {
      margin-top: 8px;
      padding: 16px;
      border-radius: 12px;
      background: #f8f9ff;
    }
    .question-text {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 8px;
    }
    .main-en {
      font-size: 1.2rem;
      font-weight: bold;
      color: #1565c0;
      margin-bottom: 4px;
    }
    .note {
      font-size: 0.75rem;
      color: #999;
      margin-top: 4px;
    }
    .choices {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .choice-btn {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fafafa;
      text-align: left;
      font-size: 0.95rem;
      cursor: pointer;
    }
    .choice-btn.correct {
      background: #c8e6c9;
      border-color: #2e7d32;
    }
    .choice-btn.wrong {
      background: #ffcdd2;
      border-color: #c62828;
    }
    .controls {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    button {
      flex: 1 1 calc(50% - 4px);
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    .btn-main {
      background: #1976d2;
      color: #fff;
    }
    .small {
      font-size: 0.75rem;
      color: #777;
      margin-top: 10px;
    }
    .debug-block {
      margin-top: 6px;
      font-size: 0.7rem;
      color: #999;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>英語リスニング単語トレーナー</h1>
    <div class="subtitle">
      埼玉県公立高校入試でよく出る「数字・場所・動詞」を中心に出題します。<br>
      3回正解すると、ステップ2に自動的に進みます。間違えた問題は数日後にまた登場します。<br>
      ▶ ステップ1：音声を聞く → 答える<br>
      ▶ ステップ2：英単語を見る → 答える<br><br>
      ※進捗はこの端末のブラウザに保存されます。同じ端末で続けてね。
    </div>

    <div class="card">
      <div class="question-text" id="questionTextLabel">
        &#128538; <b>音声を聞いて、正しい日本語を選ぼう。</b>
      </div>

      <div class="main-en" id="enHint"></div>
      <div class="choices" id="choices"></div>
      <div class="note" id="note"></div>
    </div>

    <div class="controls">
      <button id="audioBtn" class="btn-main">▶音声を聞く</button>
      <button id="skipBtn" class="btn-secondary">スキップ</button>
      <button id="nextBtn" class="btn-secondary">次へ進む</button>
    </div>

    <div class="small">
      <div class="status" id="dateInfo"></div>
      <div class="status" id="queueInfo"></div>
      <div class="status" id="wordInfo"></div>

      <!-- デバッグ用 -->
      <div class="debug-block" id="debugInfo"></div>
      <div class="debug-block" id="debugIds"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ★★ スプレッドシートのCSV公開URL ★★
    const SHEET_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfd2xAvuIy1Z_v7xUUVFb6jPrdciEgQ_dbf88oYxGs2OV03zan_o7n4hpeFGXUABn3LfYcaRqMwy35/pub?gid=97402127&single=true&output=csv";

    // 1日の出題数
    const DAILY_TARGET = 15;

    // id ベースで core / extra を判定（1〜75: core, 76〜: extra）
    const isCore = q => q.id <= 75;

    // 経過日数ごとの core / extra 比率（0〜1）
    const PHASES = [
      { maxDay: 4,   coreRatio: 0.9 }, // 0〜4日目: core 9割
      { maxDay: 9,   coreRatio: 0.6 }, // 5〜9日目: core 6割
      { maxDay: 999, coreRatio: 0.3 }  // 10日目〜: core 3割（extra多め）
    ];

    function getPhase(days) {
      for (const p of PHASES) {
        if (days <= p.maxDay) return p;
      }
      return PHASES[PHASES.length - 1];
    }

    // ============================
    // 1. スプレッドシートから問題を読み込む
    // ============================
    let questions = [];

    async function loadQuestionsFromSheet() {
      try {
        const res = await fetch(SHEET_CSV_URL);
        if (!res.ok) throw new Error("HTTPエラー: " + res.status);

        const csvText = await res.text();

        const parsed = Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true
        });

        if (parsed.errors && parsed.errors.length > 0) {
          noteEl.textContent = "CSV解析エラー: " + parsed.errors[0].message;
          console.log(parsed.errors);
        }

        const rawRows = parsed.data.length;

        // 行→内部オブジェクト
        questions = parsed.data
          .map((row, idx) => {
            const correctIdx = Number(row.correct || "1") - 1;
            return {
              id: Number(row.id || idx + 1),
              type: (row.type || "").trim(),
              category: row.category || "",
              // level は使わない
              prompt_jp: row.prompt_jp || "",
              prompt_en: row.prompt_en || "",
              en: row.en || "",
              jp: row.jp || "",
              audio_text: row.audio_text || row.en || row.prompt_en || row.prompt_jp || "",
              choices: [
                row.choice1 || "",
                row.choice2 || "",
                row.choice3 || "",
                row.choice4 || ""
              ],
              correctIndex: isNaN(correctIdx) ? 0 : correctIdx,
              pattern: row.pattern || "",
              explanation: row.explanation || "",
              note: row.note || ""
            };
          })
          // ★ 必須なのは「id がある」と「選択肢1がある」だけ
          .filter(q => q.id && q.choices[0]);

        const coreCount  = questions.filter(q => isCore(q)).length;
        const extraCount = questions.filter(q => !isCore(q)).length;

        console.log("raw rows:", rawRows);
        console.log("valid questions:", questions.length);
        console.log("core (id<=75):", coreCount);
        console.log("extra (id>=76):", extraCount);

        // 画面用デバッグ表示
        debugInfoEl.textContent =
          `CSV行数:${rawRows} / 有効:${questions.length} (core:${coreCount}, extra:${extraCount})`;
        debugIdsEl.textContent =
          "ID一覧(先頭30): " +
          questions.map(q => q.id).slice(0, 30).join(", ");

        if (questions.length === 0) {
          noteEl.textContent =
            "データは読み込めましたが、有効な問題が0件です。ヘッダー名や id / choice1 などを確認してください。";
          return;
        }

        // ★ここで extra だけテストしたいとき用（終わったら false に戻す）
        const DEBUG_EXTRA_ONLY = false;
        if (DEBUG_EXTRA_ONLY) {
          questions = questions.filter(q => !isCore(q));
          debugIdsEl.textContent =
            "DEBUG: extraのみ(先頭30): " +
            questions.map(q => q.id).slice(0, 30).join(", ");
        }

        queue = getTodayQueue(questions);
        index = 0;
        renderCard();
      } catch (err) {
        console.error(err);
        noteEl.textContent = "シート読み込みエラー: " + err.message;
      }
    }

    // ============================
    // 2. 進捗管理（SRS）
    // ============================
    const progressKey  = "saitama_trainer_progress_v3";
    const startDateKey = "saitama_trainer_startDate_v3";

    // box=0,1,2,3 に対する復習間隔（日）
    const intervals = [1, 2, 5, 999];

    function todayStr() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function loadProgress() {
      try {
        return JSON.parse(localStorage.getItem(progressKey) || "{}");
      } catch (e) {
        return {};
      }
    }

    function saveProgress(p) {
      localStorage.setItem(progressKey, JSON.stringify(p));
    }

    function updateResult(id, isCorrect) {
      const prog = loadProgress();
      const now = todayStr();
      if (!prog[id]) {
        prog[id] = { box: 0, nextDue: now, correct: 0, wrong: 0 };
      }
      let box = prog[id].box;

      if (isCorrect) {
        box = Math.min(box + 1, 3);
        prog[id].correct++;
      } else {
        box = 0;
        prog[id].wrong++;
      }

      const d = new Date();
      d.setDate(d.getDate() + intervals[box]);
      prog[id].box = box;
      prog[id].nextDue = d.toISOString().slice(0, 10);
      saveProgress(prog);
    }

    function getStartDate() {
      let s = localStorage.getItem(startDateKey);
      if (!s) {
        s = todayStr(); // 初回は今日
        localStorage.setItem(startDateKey, s);
      }
      return s;
    }

    function getElapsedDays() {
      const start = new Date(getStartDate());
      const today = new Date(todayStr());
      const diffMs = today - start;
      return Math.floor(diffMs / (1000 * 60 * 60 * 24)); // 0,1,2...
    }

    // ============================
    // 3. 今日の出題キュー
    // ============================
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function takeFrom(source, n, out) {
      let count = 0;
      while (n > 0 && source.length > 0) {
        out.push(source.pop());
        n--;
        count++;
      }
      return count;
    }

    function getTodayQueue(allQuestions) {
      const prog  = loadProgress();
      const today = todayStr();
      const days  = getElapsedDays();
      const phase = getPhase(days);

      const due        = []; // 期限到来分（core/extra混在）
      const freshCore  = [];
      const freshExtra = [];

      for (const q of allQuestions) {
        const p = prog[q.id];
        const core = isCore(q);

        if (p && p.nextDue <= today) {
          due.push(q); // 復習優先
        } else if (!p) {
          (core ? freshCore : freshExtra).push(q); // 初出題
        }
        // それ以外（nextDue > today）は今日は出さない
      }

      shuffle(due);
      shuffle(freshCore);
      shuffle(freshExtra);

      const result = [];

      // 1) due を優先
      takeFrom(due, DAILY_TARGET, result);

      if (result.length >= DAILY_TARGET) {
        shuffle(result);
        return result;
      }

      // 2) 残りを core/extra 比率で補充
      const remaining = DAILY_TARGET - result.length;
      const coreNeed  = Math.round(remaining * phase.coreRatio);
      const extraNeed = remaining - coreNeed;

      takeFrom(freshCore, coreNeed, result);
      takeFrom(freshExtra, extraNeed, result);

      // 3) 片方が足りなかったら、もう片方から補充
      if (result.length < DAILY_TARGET) {
        const still = DAILY_TARGET - result.length;
        takeFrom(freshCore, still, result);
        takeFrom(freshExtra, still, result);
      }

      shuffle(result);
      return result;
    }

    // ============================
    // 4. 正解ピンポン音
    // ============================
    let audioCtx = null;
    function playCorrectSound() {
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        if (!audioCtx) audioCtx = new AC();

        const now = audioCtx.currentTime;

        const osc1 = audioCtx.createOscillator();
        const g1 = audioCtx.createGain();
        osc1.type = "sine";
        osc1.frequency.value = 880;
        g1.gain.setValueAtTime(0.0, now);
        g1.gain.linearRampToValueAtTime(0.25, now + 0.01);
        g1.gain.linearRampToValueAtTime(0.0, now + 0.12);
        osc1.connect(g1);
        g1.connect(audioCtx.destination);
        osc1.start(now);
        osc1.stop(now + 0.15);

        const osc2 = audioCtx.createOscillator();
        const g2 = audioCtx.createGain();
        osc2.type = "sine";
        osc2.frequency.value = 1320;
        g2.gain.setValueAtTime(0.0, now + 0.10);
        g2.gain.linearRampToValueAtTime(0.2, now + 0.12);
        g2.gain.linearRampToValueAtTime(0.0, now + 0.24);
        osc2.connect(g2);
        g2.connect(audioCtx.destination);
        osc2.start(now + 0.10);
        osc2.stop(now + 0.25);
      } catch (e) {}
    }

    // ============================
    // 5. 出題状態と描画
    // ============================
    let queue = [];
    let index = 0;

    const dateInfoEl = document.getElementById("dateInfo");
    const queueInfoEl = document.getElementById("queueInfo");
    const wordInfoEl  = document.getElementById("wordInfo");
    const debugInfoEl = document.getElementById("debugInfo");
    const debugIdsEl  = document.getElementById("debugIds");

    const enHintEl = document.getElementById("enHint");
    const choicesEl = document.getElementById("choices");
    const noteEl = document.getElementById("note");
    const questionTextLabel = document.getElementById("questionTextLabel");

    const audioBtn = document.getElementById("audioBtn");
    const skipBtn  = document.getElementById("skipBtn");
    const nextBtn  = document.getElementById("nextBtn");

    function getCurrent() {
      if (queue.length === 0) return null;
      return queue[index];
    }

    // レベル判定：box>=3 でステップ2
    function getStageForQuestion(q) {
      const prog = loadProgress();
      const p = prog[q.id];
      if (!p) return 1;       // 初回はレベル1
      if (p.box >= 3) return 2; // 3回以上正解でレベル2
      return 1;
    }

    function renderHeader() {
      dateInfoEl.textContent = "今日：" + todayStr();
      queueInfoEl.textContent =
        "今日の出題対象：" + queue.length + "問 / 今：" + (index + 1) + "問目";

      const prog = loadProgress();
      const q = getCurrent();
      if (!q) {
        wordInfoEl.textContent = "";
        return;
      }
      const p = prog[q.id];
      if (!p) {
        wordInfoEl.textContent =
          `ID:${q.id}　カテゴリ:${q.category || ""}　初出題`;
      } else {
        wordInfoEl.textContent =
          `ID:${q.id}　カテゴリ:${q.category || ""}　` +
          `正解:${p.correct || 0} / ミス:${p.wrong || 0} / 次回:${p.nextDue}`;
      }
    }

    function clearChoices() {
      choicesEl.innerHTML = "";
    }

    function renderCard() {
      const q = getCurrent();
      if (!q) {
        enHintEl.textContent = "";
        clearChoices();
        noteEl.textContent =
          "出題できる問題がありません。シートのデータを確認してください。";
        return;
      }
      renderHeader();

      const stage = getStageForQuestion(q);

      if (stage === 1) {
        questionTextLabel.innerHTML =
          "<b>&#128066; 音声を「聞いて」、正しい日本語を選ぼう。</b>";
        enHintEl.textContent = "";
        audioBtn.textContent = "▶ 音声を聞く";
      } else {
        questionTextLabel.innerHTML =
          "<b>&#128064; 英単語を「見て」、正しい日本語を選ぼう。</b>";
        enHintEl.textContent = q.en;
        audioBtn.textContent = "▶ もう一度音声を聞く";
      }

      clearChoices();

      const indexedChoices = q.choices.map((text, idx) => ({
        text,
        index: idx
      }));

      for (let i = indexedChoices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indexedChoices[i], indexedChoices[j]] =
          [indexedChoices[j], indexedChoices[i]];
      }

      let answered = false;

      indexedChoices.forEach(choice => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = choice.text;

        btn.onclick = () => {
          if (answered) return;
          answered = true;

          // 答えたら単語を表示（レベル1でも）
          enHintEl.textContent = q.audio_text || q.en;

          const correct = choice.index === q.correctIndex;
          if (correct) {
            btn.classList.add("correct");
            updateResult(q.id, true);
            playCorrectSound();
            setTimeout(() => nextQuestion(), 800);
          } else {
            btn.classList.add("wrong");
            updateResult(q.id, false);
            queue.push(q); // 今日の最後にもう一度
            alert("不正解… 正しい答えは『" + q.choices[q.correctIndex] + "』です。");
          }
        };

        choicesEl.appendChild(btn);
      });

      noteEl.textContent = q.note ? "メモ：" + q.note : "";
    }

    function nextQuestion() {
      index++;
      if (index >= queue.length) {
        queue = getTodayQueue(questions);
        index = 0;
        alert("今日の分は一周しました。（間違えたものはまた出てきます）");
      }
      renderCard();
    }

    // ============================
    // 6. ボタン処理
    // ============================
    audioBtn.onclick = () => {
      const q = getCurrent();
      if (!q) return;
      if (!("speechSynthesis" in window)) {
        alert("このブラウザは読み上げに対応していません。");
        return;
      }
      window.speechSynthesis.cancel();
      const text = q.audio_text || q.en;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 1.0;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    };

    skipBtn.onclick = () => {
      nextQuestion();
    };

    nextBtn.onclick = () => {
      nextQuestion();
    };

    // ============================
    // 7. 起動時：シートを読み込む
    // ============================
    loadQuestionsFromSheet().catch(err => {
      console.error(err);
      noteEl.textContent =
        "シート読み込みでエラーが起きました。URLや公開設定を確認してください。";
    });
  </script>
</body>
</html>
