<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tamil SRS Learning App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const TamilSRSApp = () => {
      const [cards, setCards] = useState([]);
      const [currentCard, setCurrentCard] = useState(null);
      const [showAnswer, setShowAnswer] = useState(false);
      const [loading, setLoading] = useState(true);
      const [todayCards, setTodayCards] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [statsMessage, setStatsMessage] = useState('');
      const [showSettings, setShowSettings] = useState(false);
      const [settings, setSettings] = useState({
        selectedTags: ['basic'],
        maxCards: 20,
        maxNewCards: 5,
        unlockedTags: ['basic']
      });
      const [availableTags, setAvailableTags] = useState([]);
      const [tagProgress, setTagProgress] = useState({});
      const [showUnlockMessage, setShowUnlockMessage] = useState(false);
      const [unlockedTagName, setUnlockedTagName] = useState('');

      const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_RNtUHj5rxFr6LCvH3r-eFrSfx6YNd_ZoDtHln2vtz86NVgs5Awq6hwZRI8i3s5iQBkfRoUNzIA7j/pub?gid=0&single=true&output=csv';

      const MASTERY_THRESHOLD = 0.7; // 70%
      const TAG_HIERARCHY = {
        'basic': ['cooking', 'travel', 'talk']
      };

      const getTodayString = () => {
        const today = new Date();
        return today.toISOString().split('T')[0];
      };

      const parseCSV = (text) => {
        const lines = text.trim().split('\n');
        
        const parseLine = (line) => {
          const result = [];
          let current = '';
          let inQuotes = false;
          
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              result.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          result.push(current.trim());
          return result;
        };
        
        const headers = parseLine(lines[0]);
        
        return lines.slice(1).map((line, idx) => {
          const values = parseLine(line);
          const card = {};
          headers.forEach((header, i) => {
            card[header] = values[i] || '';
          });
          
          if (!card.id) {
            card.id = `card_${idx}`;
          }
          
          return card;
        });
      };

      const calculateTagProgress = (allCards) => {
        const progress = {};
        const tags = [...new Set(allCards.map(c => c.tag).filter(Boolean))];
        
        tags.forEach(tag => {
          const tagCards = allCards.filter(c => c.tag === tag);
          const box3Cards = tagCards.filter(c => c.box === '3');
          const masteryRate = tagCards.length > 0 ? box3Cards.length / tagCards.length : 0;
          
          progress[tag] = {
            total: tagCards.length,
            box3: box3Cards.length,
            rate: masteryRate,
            mastered: masteryRate >= MASTERY_THRESHOLD
          };
        });
        
        return progress;
      };

      const checkAndUnlockTags = (progress, currentUnlocked) => {
        const newUnlocked = [...currentUnlocked];
        let newlyUnlockedTags = [];
        
        Object.keys(TAG_HIERARCHY).forEach(parentTag => {
          if (progress[parentTag]?.mastered) {
            const childTags = TAG_HIERARCHY[parentTag];
            childTags.forEach(childTag => {
              if (!newUnlocked.includes(childTag)) {
                newUnlocked.push(childTag);
                newlyUnlockedTags.push(childTag);
              }
            });
          }
        });
        
        return { newUnlocked, newlyUnlockedTags };
      };

      const loadCards = async () => {
        try {
          const response = await fetch(CSV_URL);
          const text = await response.text();
          const csvCards = parseCSV(text);
          
          const tags = [...new Set(csvCards.map(c => c.tag).filter(Boolean))];
          setAvailableTags(tags);
          
          const saved = localStorage.getItem('tamilSRS');
          let progress = {};
          if (saved) {
            progress = JSON.parse(saved);
          }
          
          const savedSettings = localStorage.getItem('tamilSRSSettings');
          if (savedSettings) {
            const loadedSettings = JSON.parse(savedSettings);
            setSettings(loadedSettings);
          }
          
          const mergedCards = csvCards.map(card => {
            const savedCard = progress[card.id];
            if (savedCard) {
              return { ...card, ...savedCard };
            }
            return {
              ...card,
              box: card.box || '1',
              due: card.due || getTodayString()
            };
          });
          
          setCards(mergedCards);
          saveProgress(mergedCards);
          
          const tagProg = calculateTagProgress(mergedCards);
          setTagProgress(tagProg);
          
          setLoading(false);
        } catch (error) {
          console.error('Failed to load CSV:', error);
          const saved = localStorage.getItem('tamilSRS');
          if (saved) {
            const progress = JSON.parse(saved);
            const loadedCards = Object.values(progress);
            setCards(loadedCards);
            
            const tagProg = calculateTagProgress(loadedCards);
            setTagProgress(tagProg);
          }
          setLoading(false);
        }
      };

      const saveProgress = (cardsToSave) => {
        const progress = {};
        cardsToSave.forEach(card => {
          progress[card.id] = {
            id: card.id,
            explain: card.explain, 
            box: card.box,
            due: card.due
          };
        });
        localStorage.setItem('tamilSRS', JSON.stringify(progress));
      };

      const saveSettings = (newSettings) => {
        setSettings(newSettings);
        localStorage.setItem('tamilSRSSettings', JSON.stringify(newSettings));
      };

      const getTodayCards = (allCards) => {
        const today = getTodayString();
        
        let filteredCards = allCards.filter(card => 
          settings.selectedTags.includes(card.tag)
        );
        
        const dueCards = filteredCards.filter(card => {
          if (!card.due || card.due === '') return true;
          return card.due <= today;
        });
        
        const reviewCards = dueCards.filter(card => card.box !== '1' || card.due < today);
        const newCards = dueCards.filter(card => card.box === '1' && (!card.due || card.due >= today));
        
        const shuffledReview = [...reviewCards].sort(() => Math.random() - 0.5);
        const shuffledNew = [...newCards].sort(() => Math.random() - 0.5);
        
        const limitedNew = shuffledNew.slice(0, settings.maxNewCards);
        
        const combined = [...shuffledReview, ...limitedNew];
        return combined.slice(0, settings.maxCards);
      };

      useEffect(() => {
        loadCards();
      }, []);

      useEffect(() => {
        if (cards.length > 0) {
          const today = getTodayCards(cards);
          setTodayCards(today);
          setCurrentIndex(0);
          
          if (today.length > 0) {
            setCurrentCard(today[0]);
            setStatsMessage(`ä»Šæ—¥ã®å­¦ç¿’: ${today.length}å•`);
          } else {
            setStatsMessage('ä»Šæ—¥ã®å­¦ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ï¼');
            setCurrentCard(null);
          }
        }
      }, [cards, settings.selectedTags, settings.maxCards, settings.maxNewCards]);

      useEffect(() => {
        if (showAnswer && currentCard) {
          speakTamil(currentCard.back_ta_roman);
        }
      }, [showAnswer, currentCard]);

      const speakTamil = (text) => {
        if ('speechSynthesis' in window) {
          speechSynthesis.cancel();
          
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'ta-IN';
          utterance.rate = 0.9;
          
          const voices = speechSynthesis.getVoices();
          const tamilVoice = voices.find(v => v.lang.startsWith('ta'));
          if (tamilVoice) {
            utterance.voice = tamilVoice;
          }
          
          speechSynthesis.speak(utterance);
        }
      };

      const getNextDue = (box) => {
        const today = new Date();
        const boxNum = parseInt(box);
        
        if (boxNum === 1) {
          today.setDate(today.getDate() + 1);
        } else if (boxNum === 2) {
          today.setDate(today.getDate() + 3);
        } else {
          today.setDate(today.getDate() + 7);
        }
        
        return today.toISOString().split('T')[0];
      };

      const updateCardsAndCheckUnlock = (updatedCards) => {
        setCards(updatedCards);
        saveProgress(updatedCards);
        
        const newProgress = calculateTagProgress(updatedCards);
        setTagProgress(newProgress);
        
        const { newUnlocked, newlyUnlockedTags } = checkAndUnlockTags(newProgress, settings.unlockedTags);
        
        if (newlyUnlockedTags.length > 0) {
          const newSettings = {
            ...settings,
            unlockedTags: newUnlocked,
            selectedTags: newUnlocked
          };
          saveSettings(newSettings);
          
          setUnlockedTagName(newlyUnlockedTags.join(', '));
          setShowUnlockMessage(true);
          setTimeout(() => setShowUnlockMessage(false), 5000);
        }
      };

      const handleGood = () => {
        if (!currentCard) return;
        
        const currentBox = parseInt(currentCard.box);
        const newBox = Math.min(currentBox + 1, 3);
        const newDue = getNextDue(newBox);
        
        const updatedCards = cards.map(c => 
          c.id === currentCard.id 
            ? { ...c, box: newBox.toString(), due: newDue }
            : c
        );
        
        updateCardsAndCheckUnlock(updatedCards);
        moveToNext();
      };

      const handleAgain = () => {
        if (!currentCard) return;
        
        const newDue = getNextDue(1);
        
        const updatedCards = cards.map(c => 
          c.id === currentCard.id 
            ? { ...c, box: '1', due: newDue }
            : c
        );
        
        updateCardsAndCheckUnlock(updatedCards);
        moveToNext();
      };

      const moveToNext = () => {
        setShowAnswer(false);
        
        if (currentIndex + 1 < todayCards.length) {
          setCurrentIndex(currentIndex + 1);
          setCurrentCard(todayCards[currentIndex + 1]);
        } else {
          setCurrentCard(null);
          setStatsMessage('ä»Šæ—¥ã®å­¦ç¿’ã¯å®Œäº†ã—ã¾ã—ãŸï¼');
        }
      };

      const getFrontText = () => {
        if (!currentCard) return '';
        
        const box = parseInt(currentCard.box);
        if (box === 3) {
          return currentCard.back_ta_text;
        }
        return currentCard.front_en;
      };

      const toggleTag = (tag) => {
        if (!settings.unlockedTags.includes(tag)) return;
        
        const newTags = settings.selectedTags.includes(tag)
          ? settings.selectedTags.filter(t => t !== tag)
          : [...settings.selectedTags, tag];
        
        if (newTags.length === 0) return;
        
        saveSettings({ ...settings, selectedTags: newTags });
      };

      const selectAllTags = () => {
        saveSettings({ ...settings, selectedTags: [...settings.unlockedTags] });
      };

      const deselectAllTags = () => {
        saveSettings({ ...settings, selectedTags: ['basic'] });
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 flex items-center justify-center">
            <div className="text-xl text-gray-700">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 p-4">
          <div className="max-w-2xl mx-auto">
            {showUnlockMessage && (
              <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 animate-bounce">
                ğŸ‰ {unlockedTagName} ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸï¼
              </div>
            )}

            <div className="text-center mb-8 pt-8">
              <div className="flex items-center justify-center gap-4 mb-2">
                <h1 className="text-4xl font-bold text-orange-800">
                  à®¤à®®à®¿à®´à¯ SRS
                </h1>
                <button
                  onClick={() => setShowSettings(!showSettings)}
                  className="p-2 rounded-lg hover:bg-white/50 transition-colors"
                  title="è¨­å®š"
                >
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 1v6m0 6v6m5.2-13.2l-4.2 4.2m0 6l4.2 4.2M23 12h-6m-6 0H1m18.2 5.2l-4.2-4.2m-6 0l-4.2 4.2"></path>
                  </svg>
                </button>
              </div>
              <p className="text-gray-600">English â†’ Tamil Learning</p>
              
              {/* ç¿’å¾—ç‡è¡¨ç¤º */}
              <div className="mt-4 flex flex-wrap justify-center gap-3">
                {availableTags.map(tag => {
                  const prog = tagProgress[tag];
                  if (!prog) return null;
                  
                  const isUnlocked = settings.unlockedTags.includes(tag);
                  const percentage = Math.round(prog.rate * 100);
                  
                  return (
                    <div 
                      key={tag}
                      className={`px-4 py-2 rounded-lg text-sm ${
                        isUnlocked 
                          ? prog.mastered 
                            ? 'bg-green-100 text-green-800 border-2 border-green-400' 
                            : 'bg-blue-100 text-blue-800'
                          : 'bg-gray-200 text-gray-500'
                      }`}
                    >
                      {!isUnlocked && 'ğŸ”’ '}
                      {prog.mastered && 'âœ“ '}
                      <span className="font-semibold">{tag}</span>
                      <span className="ml-2">{percentage}%</span>
                    </div>
                  );
                })}
              </div>
              
              <p className="text-sm text-gray-500 mt-3">{statsMessage}</p>
            </div>

            {showSettings && (
              <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <h2 className="text-xl font-bold text-gray-800 mb-4">å­¦ç¿’è¨­å®š</h2>
                
                <div className="space-y-6">
                  {/* ã‚¿ã‚°é¸æŠ */}
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <label className="text-sm font-semibold text-gray-700">å­¦ç¿’ç¯„å›²ï¼ˆã‚¿ã‚°ï¼‰</label>
                      <div className="flex gap-2">
                        <button
                          onClick={selectAllTags}
                          className="text-xs px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
                        >
                          å…¨é¸æŠ
                        </button>
                        <button
                          onClick={deselectAllTags}
                          className="text-xs px-3 py-1 bg-gray-200 rounded hover:bg-gray-300"
                        >
                          basic ã®ã¿
                        </button>
                      </div>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {availableTags.map(tag => {
                        const isUnlocked = settings.unlockedTags.includes(tag);
                        const isSelected = settings.selectedTags.includes(tag);
                        
                        return (
                          <button
                            key={tag}
                            onClick={() => toggleTag(tag)}
                            disabled={!isUnlocked}
                            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                              !isUnlocked
                                ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                : isSelected
                                ? 'bg-orange-500 text-white'
                                : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                            }`}
                          >
                            {!isUnlocked && 'ğŸ”’ '}
                            {tag}
                          </button>
                        );
                      })}
                    </div>
                    <p className="text-xs text-gray-500 mt-2">
                      â€»ã‚¿ã‚°ã¯70%é”æˆã§è§£æ”¾ã•ã‚Œã¾ã™
                    </p>
                  </div>

                  {/* 1æ—¥ã®ä¸Šé™ */}
                  <div>
                    <label className="text-sm font-semibold text-gray-700 block mb-2">
                      1æ—¥ã®å­¦ç¿’ä¸Šé™: {settings.maxCards}å•
                    </label>
                    <input
                      type="range"
                      min="5"
                      max="50"
                      step="5"
                      value={settings.maxCards}
                      onChange={(e) => saveSettings({ ...settings, maxCards: parseInt(e.target.value) })}
                      className="w-full"
                    />
                    <div className="flex justify-between text-xs text-gray-500">
                      <span>5</span>
                      <span>50</span>
                    </div>
                  </div>

                  {/* æ–°è¦ã‚«ãƒ¼ãƒ‰ä¸Šé™ */}
                  <div>
                    <label className="text-sm font-semibold text-gray-700 block mb-2">
                      æ–°è¦ã‚«ãƒ¼ãƒ‰ä¸Šé™: {settings.maxNewCards}å•/æ—¥
                    </label>
                    <input
                      type="range"
                      min="0"
                      max="20"
                      step="1"
                      value={settings.maxNewCards}
                      onChange={(e) => saveSettings({ ...settings, maxNewCards: parseInt(e.target.value) })}
                      className="w-full"
                    />
                    <div className="flex justify-between text-xs text-gray-500">
                      <span>0</span>
                      <span>20</span>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {currentCard ? (
              <div className="bg-white rounded-2xl shadow-xl p-8 mb-4">
                <div className="mb-8">
                  <div className="text-sm text-gray-500 mb-2">
                    {parseInt(currentCard.box) === 3 ? 'ã‚¿ãƒŸãƒ«æ–‡å­— â†’ èª­ã¿' : 'è‹±èª â†’ ã‚¿ãƒŸãƒ«èª'}
                  </div>
                  <div className="text-3xl font-semibold text-center text-gray-800 py-8">
                    {getFrontText()}
                  </div>
                  <div className="text-xs text-gray-400 text-center">
                    Box {currentCard.box} | {currentCard.tag}
                  </div>
                </div>

                {!showAnswer && (
                  <button
                    onClick={() => setShowAnswer(true)}
                    className="w-full py-4 bg-orange-500 text-white rounded-xl text-lg font-semibold hover:bg-orange-600 transition-colors"
                  >
                    ç­”ãˆã‚’è¦‹ã‚‹
                  </button>
                )}

                {showAnswer && (
                  <div className="space-y-6">
                    <div className="border-t pt-6">
                      <div className="space-y-4">
                        <div>
                          <div className="text-sm text-gray-500 mb-1">ãƒ­ãƒ¼ãƒå­—</div>
                          <div className="text-2xl font-semibold text-orange-700">
                            {currentCard.back_ta_roman}
                          </div>
                        </div>
                        
                        <div>
                          <div className="text-sm text-gray-500 mb-1">ã‚¿ãƒŸãƒ«æ–‡å­—</div>
                          <div className="text-3xl font-semibold text-gray-800">
                            {currentCard.back_ta_text}
                          </div>
                        </div>

                        {currentCard.explain && (
                          <div>
                            <div className="text-sm text-gray-500 mb-1">è£œè¶³</div>
                            <div className="text-base text-gray-800 whitespace-pre-wrap">
                              {currentCard.explain}
                            </div>
                          </div>
                        )}
                        
                        {parseInt(currentCard.box) === 3 && (
                          <div>
                            <div className="text-sm text-gray-500 mb-1">è‹±èª</div>
                            <div className="text-xl text-gray-700">
                              {currentCard.front_en}
                            </div>
                          </div>
                        )}
                      </div>

                      {'speechSynthesis' in window && (
                        <button
                          onClick={() => speakTamil(currentCard.back_ta_roman)}
                          className="mt-4 flex items-center gap-2 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                        >
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                          </svg>
                          éŸ³å£°ã‚’èã
                        </button>
                      )}
                    </div>

                    <div className="flex gap-4">
                      <button
                        onClick={handleAgain}
                        className="flex-1 py-4 bg-red-500 text-white rounded-xl text-lg font-semibold hover:bg-red-600 transition-colors"
                      >
                        Again
                      </button>
                      <button
                        onClick={handleGood}
                        className="flex-1 py-4 bg-green-500 text-white rounded-xl text-lg font-semibold hover:bg-green-600 transition-colors"
                      >
                        Good
                      </button>
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
                <div className="text-6xl mb-4">ğŸ‰</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                  {cards.length === 0 ? 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“' : 'ä»Šæ—¥ã®å­¦ç¿’ã¯å®Œäº†ã—ã¾ã—ãŸï¼'}
                </h2>
                <button
                  onClick={loadCards}
                  className="mt-4 flex items-center gap-2 mx-auto px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                  å†èª­ã¿è¾¼ã¿
                </button>
              </div>
            )}

            <div className="text-center text-sm text-gray-500 mt-8">
              <p>Box1: æ¯æ—¥ | Box2: 3æ—¥ãŠã | Box3: 7æ—¥ãŠã</p>
              <p className="mt-2">åˆè¨ˆ: {cards.length}å•</p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<TamilSRSApp />, document.getElementById('root'));
  </script>
</body>
</html>
