<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tamil SRS Learning App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const TamilSRSApp = () => {
      const [cards, setCards] = useState([]);
      const [currentCard, setCurrentCard] = useState(null);
      const [showAnswer, setShowAnswer] = useState(false);
      const [loading, setLoading] = useState(true);
      const [todayCards, setTodayCards] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [statsMessage, setStatsMessage] = useState('');

      const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ_RNtUHj5rxFr6LCvH3r-eFrSfx6YNd_ZoDtHln2vtz86NVgs5Awq6hwZRI8i3s5iQBkfRoUNzIA7j/pub?gid=0&single=true&output=csv';

      const getTodayString = () => {
        const today = new Date();
        return today.toISOString().split('T')[0];
      };

      const parseCSV = (text) => {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        
        return lines.slice(1).map((line, idx) => {
          const values = line.split(',').map(v => v.trim());
          const card = {};
          headers.forEach((header, i) => {
            card[header] = values[i] || '';
          });
          
          if (!card.id) {
            card.id = `card_${idx}`;
          }
          
          return card;
        });
      };

      const loadCards = async () => {
        try {
          const response = await fetch(CSV_URL);
          const text = await response.text();
          const csvCards = parseCSV(text);
          
          const saved = localStorage.getItem('tamilSRS');
          let progress = {};
          if (saved) {
            progress = JSON.parse(saved);
          }
          
          const mergedCards = csvCards.map(card => {
            const savedCard = progress[card.id];
            if (savedCard) {
              return { ...card, ...savedCard };
            }
            return {
              ...card,
              box: card.box || '1',
              due: card.due || getTodayString()
            };
          });
          
          setCards(mergedCards);
          saveProgress(mergedCards);
          setLoading(false);
        } catch (error) {
          console.error('Failed to load CSV:', error);
          const saved = localStorage.getItem('tamilSRS');
          if (saved) {
            const progress = JSON.parse(saved);
            const loadedCards = Object.values(progress);
            setCards(loadedCards);
          }
          setLoading(false);
        }
      };

      const saveProgress = (cardsToSave) => {
        const progress = {};
        cardsToSave.forEach(card => {
          progress[card.id] = {
            id: card.id,
            tag: card.tag,
            front_en: card.front_en,
            back_ta_roman: card.back_ta_roman,
            back_ta_text: card.back_ta_text,
            box: card.box,
            due: card.due
          };
        });
        localStorage.setItem('tamilSRS', JSON.stringify(progress));
      };

      const getTodayCards = (allCards) => {
        const today = getTodayString();
        const dueCards = allCards.filter(card => {
          if (!card.due || card.due === '') return true;
          return card.due <= today;
        });
        
        const shuffled = [...dueCards].sort(() => Math.random() - 0.5);
        return shuffled;
      };

      useEffect(() => {
        loadCards();
      }, []);

      useEffect(() => {
        if (cards.length > 0) {
          const today = getTodayCards(cards);
          setTodayCards(today);
          setCurrentIndex(0);
          
          if (today.length > 0) {
            setCurrentCard(today[0]);
            setStatsMessage(`ä»Šæ—¥ã®å­¦ç¿’: ${today.length}å•`);
          } else {
            setStatsMessage('ä»Šæ—¥ã®å­¦ç¿’ã¯ã‚ã‚Šã¾ã›ã‚“ï¼');
            setCurrentCard(null);
          }
        }
      }, [cards]);

      const speakTamil = (text) => {
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'ta-IN';
          utterance.rate = 0.9;
          
          const voices = speechSynthesis.getVoices();
          const tamilVoice = voices.find(v => v.lang.startsWith('ta'));
          if (tamilVoice) {
            utterance.voice = tamilVoice;
          }
          
          speechSynthesis.speak(utterance);
        }
      };

      const getNextDue = (box) => {
        const today = new Date();
        const boxNum = parseInt(box);
        
        if (boxNum === 1) {
          today.setDate(today.getDate() + 1);
        } else if (boxNum === 2) {
          today.setDate(today.getDate() + 3);
        } else {
          today.setDate(today.getDate() + 7);
        }
        
        return today.toISOString().split('T')[0];
      };

      const handleGood = () => {
        if (!currentCard) return;
        
        const currentBox = parseInt(currentCard.box);
        const newBox = Math.min(currentBox + 1, 3);
        const newDue = getNextDue(newBox);
        
        const updatedCards = cards.map(c => 
          c.id === currentCard.id 
            ? { ...c, box: newBox.toString(), due: newDue }
            : c
        );
        
        setCards(updatedCards);
        saveProgress(updatedCards);
        moveToNext();
      };

      const handleAgain = () => {
        if (!currentCard) return;
        
        const newDue = getNextDue(1);
        
        const updatedCards = cards.map(c => 
          c.id === currentCard.id 
            ? { ...c, box: '1', due: newDue }
            : c
        );
        
        setCards(updatedCards);
        saveProgress(updatedCards);
        moveToNext();
      };

      const moveToNext = () => {
        setShowAnswer(false);
        
        if (currentIndex + 1 < todayCards.length) {
          setCurrentIndex(currentIndex + 1);
          setCurrentCard(todayCards[currentIndex + 1]);
        } else {
          setCurrentCard(null);
          setStatsMessage('ä»Šæ—¥ã®å­¦ç¿’ã¯å®Œäº†ã—ã¾ã—ãŸï¼');
        }
      };

      const getFrontText = () => {
        if (!currentCard) return '';
        
        const box = parseInt(currentCard.box);
        if (box === 3) {
          return currentCard.back_ta_text;
        }
        return currentCard.front_en;
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 flex items-center justify-center">
            <div className="text-xl text-gray-700">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 p-4">
          <div className="max-w-2xl mx-auto">
            <div className="text-center mb-8 pt-8">
              <h1 className="text-4xl font-bold text-orange-800 mb-2">
                à®¤à®®à®¿à®´à¯ SRS
              </h1>
              <p className="text-gray-600">English â†’ Tamil Learning</p>
              <p className="text-sm text-gray-500 mt-2">{statsMessage}</p>
            </div>

            {currentCard ? (
              <div className="bg-white rounded-2xl shadow-xl p-8 mb-4">
                <div className="mb-8">
                  <div className="text-sm text-gray-500 mb-2">
                    {parseInt(currentCard.box) === 3 ? 'ã‚¿ãƒŸãƒ«æ–‡å­— â†’ èª­ã¿' : 'è‹±èª â†’ ã‚¿ãƒŸãƒ«èª'}
                  </div>
                  <div className="text-3xl font-semibold text-center text-gray-800 py-8">
                    {getFrontText()}
                  </div>
                  <div className="text-xs text-gray-400 text-center">
                    Box {currentCard.box} | {currentCard.tag}
                  </div>
                </div>

                {!showAnswer && (
                  <button
                    onClick={() => setShowAnswer(true)}
                    className="w-full py-4 bg-orange-500 text-white rounded-xl text-lg font-semibold hover:bg-orange-600 transition-colors"
                  >
                    ç­”ãˆã‚’è¦‹ã‚‹
                  </button>
                )}

                {showAnswer && (
                  <div className="space-y-6">
                    <div className="border-t pt-6">
                      <div className="space-y-4">
                        <div>
                          <div className="text-sm text-gray-500 mb-1">ãƒ­ãƒ¼ãƒå­—</div>
                          <div className="text-2xl font-semibold text-orange-700">
                            {currentCard.back_ta_roman}
                          </div>
                        </div>
                        
                        <div>
                          <div className="text-sm text-gray-500 mb-1">ã‚¿ãƒŸãƒ«æ–‡å­—</div>
                          <div className="text-3xl font-semibold text-gray-800">
                            {currentCard.back_ta_text}
                          </div>
                        </div>

                        {parseInt(currentCard.box) === 3 && (
                          <div>
                            <div className="text-sm text-gray-500 mb-1">è‹±èª</div>
                            <div className="text-xl text-gray-700">
                              {currentCard.front_en}
                            </div>
                          </div>
                        )}
                      </div>

                      {'speechSynthesis' in window && (
                        <button
                          onClick={() => speakTamil(currentCard.back_ta_roman)}
                          className="mt-4 flex items-center gap-2 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                        >
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                          </svg>
                          éŸ³å£°ã‚’èã
                        </button>
                      )}
                    </div>

                    <div className="flex gap-4">
                      <button
                        onClick={handleAgain}
                        className="flex-1 py-4 bg-red-500 text-white rounded-xl text-lg font-semibold hover:bg-red-600 transition-colors"
                      >
                        Again
                      </button>
                      <button
                        onClick={handleGood}
                        className="flex-1 py-4 bg-green-500 text-white rounded-xl text-lg font-semibold hover:bg-green-600 transition-colors"
                      >
                        Good
                      </button>
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
                <div className="text-6xl mb-4">ğŸ‰</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                  {cards.length === 0 ? 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“' : 'ä»Šæ—¥ã®å­¦ç¿’ã¯å®Œäº†ã—ã¾ã—ãŸï¼'}
                </h2>
                <button
                  onClick={loadCards}
                  className="mt-4 flex items-center gap-2 mx-auto px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors"
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                  å†èª­ã¿è¾¼ã¿
                </button>
              </div>
            )}

            <div className="text-center text-sm text-gray-500 mt-8">
              <p>Box1: æ¯æ—¥ | Box2: 3æ—¥ãŠã | Box3: 7æ—¥ãŠã</p>
              <p className="mt-2">åˆè¨ˆ: {cards.length}å•</p>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<TamilSRSApp />, document.getElementById('root'));
  </script>
</body>
</html>
