<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>理科トレーナー（埼玉入試対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin: 8px 0 4px;
    }
    .subtitle {
      font-size: 0.85rem;
      text-align: center;
      color: #666;
      margin-bottom: 8px;
    }
    .status-text {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 8px;
      text-align: center;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }
    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      white-space: nowrap;
    }
    button.secondary {
      background: #eee;
      color: #333;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .question-category {
      display: inline-block;
      font-size: 0.82rem;
      color: #333;
      background: #e0e0e0;
      padding: 2px 8px;
      border-radius: 999px;
      margin-bottom: 4px;
    }
    .question-text {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
      line-height: 1.5;
      color: #222;
    }
    .image-box {
      text-align: center;
      margin: 8px 0;
    }
    .image-box img {
      max-width: 100%;
      border-radius: 8px;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    .choice-btn {
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fafafa;
      font-size: 0.95rem;
      color: #333;
    }
    .choice-btn.correct {
      background: #c8e6c9;
      border-color: #2e7d32;
      color: #1b5e20;
    }
    .choice-btn.incorrect {
      background: #ffcdd2;
      border-color: #c62828;
      color: #b71c1c;
    }
    .result-text {
      margin-top: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #333;
    }
    .result-text.correct {
      color: #2e7d32;
    }
    .result-text.incorrect {
      color: #c62828;
    }
    .action-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .explanation-box {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f1f8e9;
      font-size: 0.9rem;
      line-height: 1.5;
      display: none;
      color: #333;
    }
    .explain-image {
      text-align: center;
      margin-top: 8px;
    }
    .explain-image img {
      max-width: 100%;
      border-radius: 8px;
    }
    .stats {
      font-size: 0.8rem;
      color: #555;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.2rem;
      }
      button {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>理科トレーナー</h1>
    <div class="subtitle">埼玉県公立高校入試対策（4択クイズ）</div>
    <div class="status-text" id="statusText">問題データを読み込んでいます…</div>

    <div class="card" id="quizCard" style="display:none;">
      <div class="question-category" id="questionCategory"></div>
      <div class="question-text" id="questionText"></div>
      <div class="image-box" id="imageBox" style="display:none;">
        <img id="questionImage" src="" alt="question image">
      </div>
      <div class="choices" id="choicesBox"></div>
      <div class="result-text" id="resultText"></div>
      <div class="action-row">
        <button id="explainBtn" class="secondary" style="display:none;">解説を見る</button>
        <button id="nextBtn" class="secondary" style="display:none;">次の問題</button>
      </div>
      <div class="explanation-box" id="explanationBox"></div>
      <div class="stats" id="statsText"></div>
    </div>
  </div>

  <script>
    // ★ 裏側で固定しておく Google Sheets CSV の URL
    var DEFAULT_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfd2xAvuIy1Z_v7xUUVFb6jPrdciEgQ_dbf88oYxGs2OV03zan_o7n4hpeFGXUABn3LfYcaRqMwy35/pub?gid=305193808&single=true&output=csv";

    // データと状態
    var questions = [];
    var currentQuestion = null;
    var currentShuffle = [];         // 選択肢の並び（元の index の配列）
    var currentCorrectBtnIndex = 0;  // 並び替え後で何番が正解か
    var answeredCount = 0;
    var correctCount = 0;

    // DOM
    var statusText     = document.getElementById("statusText");
    var quizCard       = document.getElementById("quizCard");
    var questionCategory = document.getElementById("questionCategory");
    var questionText   = document.getElementById("questionText");
    var imageBox       = document.getElementById("imageBox");
    var questionImage  = document.getElementById("questionImage");
    var choicesBox     = document.getElementById("choicesBox");
    var resultText     = document.getElementById("resultText");
    var explainBtn     = document.getElementById("explainBtn");
    var nextBtn        = document.getElementById("nextBtn");
    var explanationBox = document.getElementById("explanationBox");
    var statsText      = document.getElementById("statsText");

    function setStatus(msg) {
      statusText.textContent = msg;
    }

    // ざっくり CSV を分割（タブ or カンマ）
    function parseSeparatedLine(line, delimiter) {
      return line.split(delimiter).map(function (part) {
        return part.trim();
      });
    }

    // 配列シャッフル（Fisher–Yates）
    function shuffleArray(arr) {
      for (var i = arr.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var tmp = arr[i];
        arr[i] = arr[j];
        arr[j] = tmp;
      }
      return arr;
    }

    function loadCsvFromUrl(url) {
      setStatus("問題データを読み込んでいます…");
      fetch(url)
        .then(function (res) {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.text();
        })
        .then(function (text) {
          var lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
          if (lines.length <= 1) throw new Error("データがありません（1行しかありません）");

          var delimiter = "\t";
          if (lines[0].indexOf("\t") === -1 && lines[0].indexOf(",") !== -1) {
            delimiter = ",";
          }

          var header = parseSeparatedLine(lines[0], delimiter);
          var idx = {
            id: header.indexOf("id"),
            category: header.indexOf("category"),
            question: header.indexOf("question"),
            choice1: header.indexOf("choice1"),
            choice2: header.indexOf("choice2"),
            choice3: header.indexOf("choice3"),
            choice4: header.indexOf("choice4"),
            correct: header.indexOf("correct"),
            image: header.indexOf("image"),
            explanation: header.indexOf("explanation"),
            explanation_image: header.indexOf("explanation_image"),
            note: header.indexOf("note")
          };

          if (idx.id === -1 || idx.question === -1 || idx.correct === -1) {
            throw new Error("ヘッダー行が足りません（id, question, correct は必須）");
          }

          var result = [];
          for (var i = 1; i < lines.length; i++) {
            var line = lines[i];
            if (!line.trim()) continue;
            var cols = parseSeparatedLine(line, delimiter);

            var choices = [];
            if (idx.choice1 >= 0) choices.push(cols[idx.choice1] || "");
            if (idx.choice2 >= 0) choices.push(cols[idx.choice2] || "");
            if (idx.choice3 >= 0) choices.push(cols[idx.choice3] || "");
            if (idx.choice4 >= 0) choices.push(cols[idx.choice4] || "");

            if (choices.length === 0) continue; // 選択肢ゼロはスキップ

            var correctIndex = 0;
            if (cols[idx.correct]) {
              var n = parseInt(cols[idx.correct], 10);
              if (!isNaN(n) && n >= 1 && n <= choices.length) {
                correctIndex = n - 1; // 0始まりに修正
              }
            }

            result.push({
              id: cols[idx.id] || String(i),
              category: idx.category >= 0 ? (cols[idx.category] || "") : "",
              question: cols[idx.question] || "",
              choices: choices,
              correctIndex: correctIndex,
              image: idx.image >= 0 ? (cols[idx.image] || "") : "",
              explanation: idx.explanation >= 0 ? (cols[idx.explanation] || "") : "",
              explanationImage: idx.explanation_image >= 0 ? (cols[idx.explanation_image] || "") : "",
              note: idx.note >= 0 ? (cols[idx.note] || "") : ""
            });
          }

          questions = result;
          if (questions.length === 0) throw new Error("有効な問題がありませんでした。");

          answeredCount = 0;
          correctCount = 0;
          quizCard.style.display = "block";
          setStatus("読み込み完了：問題数 " + questions.length + " 問");
          showNextQuestion();
        })
        .catch(function (err) {
          setStatus("読み込みエラー: " + err.message);
          quizCard.style.display = "none";
        });
    }

    // ランダムに1問選ぶだけ（シンプル）
    function pickRandomQuestion() {
      if (!questions || questions.length === 0) return null;
      var index = Math.floor(Math.random() * questions.length);
      return questions[index];
    }

    function clearQuestionUI() {
      questionCategory.textContent = "";
      questionText.textContent = "";
      imageBox.style.display = "none";
      questionImage.src = "";
      choicesBox.innerHTML = "";
      resultText.textContent = "";
      resultText.className = "result-text";
      explanationBox.style.display = "none";
      explanationBox.innerHTML = "";
      explainBtn.style.display = "none";
      nextBtn.style.display = "none";
    }

    function showNextQuestion() {
      clearQuestionUI();
      currentQuestion = pickRandomQuestion();
      if (!currentQuestion) {
        questionText.textContent = "出題できる問題が見つかりませんでした。";
        return;
      }

      questionCategory.textContent = currentQuestion.category || "";
      questionText.textContent = currentQuestion.question;

      if (currentQuestion.image) {
        imageBox.style.display = "block";
        questionImage.src = currentQuestion.image;
      }

      // 選択肢の並びをランダムに決める
      var n = currentQuestion.choices.length;
      var indices = [];
      for (var i = 0; i < n; i++) indices.push(i);
      currentShuffle = shuffleArray(indices);
      currentCorrectBtnIndex = currentShuffle.indexOf(currentQuestion.correctIndex); // このボタン番号が正解

      // ボタン生成
      for (var b = 0; b < n; b++) {
        var choiceIdx = currentShuffle[b];
        var btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = (b + 1) + ". " + currentQuestion.choices[choiceIdx];
        btn.dataset.index = String(b); // 並び後の番号
        btn.addEventListener("click", onChoiceClick);
        choicesBox.appendChild(btn);
      }

      updateStats();
    }

    function onChoiceClick(event) {
      var btn = event.currentTarget;
      var selectedBtnIndex = parseInt(btn.dataset.index, 10);

      var buttons = choicesBox.querySelectorAll("button");
      buttons.forEach(function (b) {
        b.disabled = true;
      });

      answeredCount += 1;
      var isCorrect = (selectedBtnIndex === currentCorrectBtnIndex);
      if (isCorrect) {
        correctCount += 1;
        resultText.textContent = "⭕ 正解！";
        resultText.className = "result-text correct";
      } else {
        var correctNo = currentCorrectBtnIndex + 1; // 表示上の番号
        resultText.textContent = "❌ 不正解…　正解は「" + correctNo + "番」です。";
        resultText.className = "result-text incorrect";
      }

      // ボタンの色付け
      buttons.forEach(function (b) {
        var idx = parseInt(b.dataset.index, 10);
        if (idx === currentCorrectBtnIndex) {
          b.classList.add("correct");
        } else if (idx === selectedBtnIndex) {
          b.classList.add("incorrect");
        }
      });

      // 解説ボタン／次の問題ボタン
      if ((currentQuestion.explanation && currentQuestion.explanation.trim() !== "") ||
          (currentQuestion.explanationImage && currentQuestion.explanationImage.trim() !== "")) {
        explainBtn.style.display = "inline-block";
        explainBtn.textContent = "解説を見る";
      }
      nextBtn.style.display = "inline-block";

      updateStats();
    }

    function updateStats() {
      if (answeredCount === 0) {
        statsText.textContent = "まだ回答していません。";
      } else {
        var rate = Math.round((correctCount / answeredCount) * 100);
        statsText.textContent =
          "今日の回答数: " + answeredCount +
          "／ 正解数: " + correctCount +
          "／ 正答率: " + rate + "%";
      }
    }

    function toggleExplanation() {
      if (!currentQuestion) return;
      if (explanationBox.style.display === "none") {
        var html = "";
        if (currentQuestion.explanation && currentQuestion.explanation.trim() !== "") {
          html += currentQuestion.explanation.replace(/\n/g, "<br>");
        }
        if (currentQuestion.explanationImage && currentQuestion.explanationImage.trim() !== "") {
          html += '<div class="explain-image"><img src="' +
                  currentQuestion.explanationImage +
                  '" alt="explanation image"></div>';
        }
        if (!html) {
          html = "解説は登録されていません。";
        }
        explanationBox.innerHTML = html;
        explanationBox.style.display = "block";
        explainBtn.textContent = "解説を閉じる";
      } else {
        explanationBox.style.display = "none";
        explainBtn.textContent = "解説を見る";
      }
    }

    // イベント
    explainBtn.addEventListener("click", toggleExplanation);
    nextBtn.addEventListener("click", showNextQuestion);

    // ページ表示時に自動読み込み
    window.addEventListener("load", function () {
      loadCsvFromUrl(DEFAULT_CSV_URL);
    });
  </script>
</body>
</html>
