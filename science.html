<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>理科トレーナー（埼玉入試対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.4rem;
      text-align: center;
      margin: 8px 0 4px;
    }
    .subtitle {
      font-size: 0.85rem;
      text-align: center;
      color: #666;
      margin-bottom: 8px;
    }
    .status-text {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 8px;
      text-align: center;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }
    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      white-space: nowrap;
    }
    button.secondary {
      background: #eee;
      color: #333;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .question-category {
      font-size: 0.85rem;
      color: #777;
      margin-bottom: 4px;
    }
    .question-text {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .image-box {
      text-align: center;
      margin: 8px 0;
    }
    .image-box img {
      max-width: 100%;
      border-radius: 8px;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    .choice-btn {
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fafafa;
      font-size: 0.95rem;
    }
    .choice-btn.correct {
      background: #c8e6c9;
      border-color: #2e7d32;
      color: #1b5e20;
    }
    .choice-btn.incorrect {
      background: #ffcdd2;
      border-color: #c62828;
      color: #b71c1c;
    }
    .result-text {
      margin-top: 8px;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .result-text.correct {
      color: #2e7d32;
    }
    .result-text.incorrect {
      color: #c62828;
    }
    .action-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .explanation-box {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f1f8e9;
      font-size: 0.9rem;
      line-height: 1.5;
      display: none;
    }
    .stats {
      font-size: 0.8rem;
      color: #555;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.2rem;
      }
      button {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>理科トレーナー</h1>
    <div class="subtitle">埼玉県公立高校入試対策（間隔反復＆4択クイズ）</div>
    <div class="status-text" id="statusText">問題データを読み込んでいます…</div>

    <div class="card" id="quizCard" style="display:none;">
      <div class="question-category" id="questionCategory"></div>
      <div class="question-text" id="questionText"></div>
      <div class="image-box" id="imageBox" style="display:none;">
        <img id="questionImage" src="" alt="question image">
      </div>
      <div class="choices" id="choicesBox"></div>
      <div class="result-text" id="resultText"></div>
      <div class="action-row">
        <button id="explainBtn" class="secondary" style="display:none;">解説を見る</button>
        <button id="nextBtn" class="secondary" style="display:none;">次の問題</button>
      </div>
      <div class="explanation-box" id="explanationBox"></div>
      <div class="stats" id="statsText"></div>
    </div>
  </div>

  <script>
    // ====== ★ 固定のCSV URL（裏側専用） ======
    var DEFAULT_CSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vSfd2xAvuIy1Z_v7xUUVFb6jPrdciEgQ_dbf88oYxGs2OV03zan_o7n4hpeFGXUABn3LfYcaRqMwy35/pub?gid=305193808&single=true&output=csv";

    // ====== データ管理用 ======
    var questions = [];
    var currentQuestion = null;
    var progress = {}; // { id: { intervalDays, nextDue, correctCount, wrongCount } }
    var answeredCount = 0;
    var correctCount = 0;
    var storageKey = "";

    // ====== DOM要素 ======
    var statusText     = document.getElementById("statusText");
    var quizCard       = document.getElementById("quizCard");
    var questionCategory = document.getElementById("questionCategory");
    var questionText   = document.getElementById("questionText");
    var imageBox       = document.getElementById("imageBox");
    var questionImage  = document.getElementById("questionImage");
    var choicesBox     = document.getElementById("choicesBox");
    var resultText     = document.getElementById("resultText");
    var explainBtn     = document.getElementById("explainBtn");
    var nextBtn        = document.getElementById("nextBtn");
    var explanationBox = document.getElementById("explanationBox");
    var statsText      = document.getElementById("statsText");

    function setStatus(msg) {
      statusText.textContent = msg;
    }

    // ====== ローカルストレージ ======
    function makeStorageKey(url) {
      return "rika_trainer_" + btoa(unescape(encodeURIComponent(url)));
    }

    function loadProgress() {
      progress = {};
      if (!storageKey) return;
      var raw = localStorage.getItem(storageKey);
      if (raw) {
        try {
          progress = JSON.parse(raw);
        } catch (e) {
          progress = {};
        }
      }
    }

    function saveProgress() {
      if (!storageKey) return;
      localStorage.setItem(storageKey, JSON.stringify(progress));
    }

    // ====== CSV / TSV 解析 ======
    function parseSeparatedLine(line, delimiter) {
      return line.split(delimiter).map(function(part) {
        return part.trim();
      });
    }

    function loadCsvFromUrl(url) {
      setStatus("問題データを読み込んでいます…");
      fetch(url)
        .then(function(res) {
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          return res.text();
        })
        .then(function(text) {
          var lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
          if (lines.length <= 1) {
            throw new Error("データがありません（1行しかありません）");
          }

          var delimiter = "\t";
          if (lines[0].indexOf("\t") === -1 && lines[0].indexOf(",") !== -1) {
            delimiter = ",";
          }

          var header = parseSeparatedLine(lines[0], delimiter);

          var idIndex         = header.indexOf("id");
          var categoryIndex   = header.indexOf("category");
          var questionIndex   = header.indexOf("question");
          var correctIndex    = header.indexOf("correct");
          var imageIndex      = header.indexOf("image");
          var explanationIndex= header.indexOf("explanation");
          var noteIndex       = header.indexOf("note");

          if (idIndex === -1 || questionIndex === -1 || correctIndex === -1) {
            throw new Error("ヘッダー行が足りません（id, question, correct は必須）");
          }

          // question と correct のあいだの列を「すべて選択肢」とみなす
          var choiceStart = questionIndex + 1;
          var choiceEnd   = correctIndex; // correct の直前まで
          if (choiceEnd - choiceStart < 1) {
            throw new Error("選択肢の列が見つかりません。question と correct の間に choice 列を置いてください。");
          }

          var result = [];
          for (var i = 1; i < lines.length; i++) {
            var line = lines[i];
            if (!line.trim()) continue;
            var cols = parseSeparatedLine(line, delimiter);

            var q = {
              id: cols[idIndex] || String(i),
              category: categoryIndex >= 0 ? (cols[categoryIndex] || "") : "",
              question: cols[questionIndex] || "",
              choices: [],
              correct: 1,
              image: imageIndex >= 0 ? (cols[imageIndex] || "") : "",
              explanation: explanationIndex >= 0 ? (cols[explanationIndex] || "") : "",
              note: noteIndex >= 0 ? (cols[noteIndex] || "") : ""
            };

            // 選択肢をまとめて取得
            for (var c = choiceStart; c < choiceEnd; c++) {
              q.choices.push(cols[c] || "");
            }
            // 一応4択前提で、足りなければ空文字を埋める
            while (q.choices.length < 4) {
              q.choices.push("");
            }

            if (cols[correctIndex]) {
              var n = parseInt(cols[correctIndex], 10);
              if (!isNaN(n) && n >= 1 && n <= q.choices.length) {
                q.correct = n;
              }
            }

            result.push(q);
          }

          questions = result;
          if (questions.length === 0) {
            throw new Error("有効な問題がありませんでした。");
          }

          answeredCount = 0;
          correctCount = 0;
          quizCard.style.display = "block";
          setStatus("読み込み完了：問題数 " + questions.length + " 問");
          showNextQuestion();
        })
        .catch(function(err) {
          setStatus("読み込みエラー: " + err.message);
          quizCard.style.display = "none";
        });
    }

    // ====== 出題ロジック（簡易・間隔反復） ======
    function pickNextQuestion() {
      if (!questions || questions.length === 0) return null;
      var now = Date.now();

      var due = questions.filter(function(q) {
        var rec = progress[q.id];
        if (!rec) return true;
        return rec.nextDue <= now;
      });

      var pool = due;
      if (pool.length === 0) {
        pool = questions;
      }

      var index = Math.floor(Math.random() * pool.length);
      return pool[index];
    }

    function updateProgress(question, isCorrect) {
      var now = Date.now();
      var rec = progress[question.id];
      if (!rec) {
        rec = {
          intervalDays: 0,
          nextDue: now,
          correctCount: 0,
          wrongCount: 0
        };
      }

      if (isCorrect) {
        rec.correctCount += 1;
        if (rec.intervalDays === 0) {
          rec.intervalDays = 1;
        } else if (rec.intervalDays === 1) {
          rec.intervalDays = 2;
        } else if (rec.intervalDays === 2) {
          rec.intervalDays = 5;
        } else {
          rec.intervalDays = 999;
        }
      } else {
        rec.wrongCount += 1;
        rec.intervalDays = 0;
      }

      rec.nextDue = now + rec.intervalDays * 24 * 60 * 60 * 1000;
      progress[question.id] = rec;
      saveProgress();
    }

    // ====== UI更新 ======
    function clearQuestionUI() {
      questionCategory.textContent = "";
      questionText.textContent = "";
      imageBox.style.display = "none";
      questionImage.src = "";
      choicesBox.innerHTML = "";
      resultText.textContent = "";
      resultText.className = "result-text";
      explanationBox.style.display = "none";
      explanationBox.textContent = "";
      explainBtn.style.display = "none";
      nextBtn.style.display = "none";
    }

    function showNextQuestion() {
      clearQuestionUI();
      currentQuestion = pickNextQuestion();
      if (!currentQuestion) {
        questionText.textContent = "出題できる問題が見つかりませんでした。";
        return;
      }

      questionCategory.textContent = currentQuestion.category || "";
      questionText.textContent = currentQuestion.question;

      if (currentQuestion.image) {
        imageBox.style.display = "block";
        questionImage.src = currentQuestion.image;
      } else {
        imageBox.style.display = "none";
        questionImage.src = "";
      }

      currentQuestion.choices.forEach(function(choiceText, i) {
        var btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = (i + 1) + ". " + choiceText;
        btn.dataset.index = String(i + 1);
        btn.addEventListener("click", onChoiceClick);
        choicesBox.appendChild(btn);
      });

      updateStats();
    }

    function onChoiceClick(event) {
      var btn = event.currentTarget;
      var selected = parseInt(btn.dataset.index, 10);
      var correct = currentQuestion.correct;

      var buttons = choicesBox.querySelectorAll("button");
      buttons.forEach(function(b) {
        b.disabled = true;
      });

      answeredCount += 1;
      var isCorrect = (selected === correct);
      if (isCorrect) {
        correctCount += 1;
        resultText.textContent = "⭕ 正解！";
        resultText.className = "result-text correct";
      } else {
        resultText.textContent = "❌ 不正解…　正解は「" + correct + "番」です。";
        resultText.className = "result-text incorrect";
      }

      buttons.forEach(function(b) {
        var idx = parseInt(b.dataset.index, 10);
        if (idx === correct) {
          b.classList.add("correct");
        } else if (idx === selected) {
          b.classList.add("incorrect");
        }
      });

      updateProgress(currentQuestion, isCorrect);

      if (currentQuestion.explanation && currentQuestion.explanation.trim() !== "") {
        explainBtn.style.display = "inline-block";
        explainBtn.textContent = "解説を見る";
      } else {
        explainBtn.style.display = "none";
      }
      nextBtn.style.display = "inline-block";

      updateStats();
    }

    function updateStats() {
      if (answeredCount === 0) {
        statsText.textContent = "まだ回答していません。";
      } else {
        var rate = Math.round((correctCount / answeredCount) * 100);
        statsText.textContent =
          "今日の回答数: " + answeredCount +
          "／ 正解数: " + correctCount +
          "／ 正答率: " + rate + "%";
      }
    }

    function toggleExplanation() {
      if (!currentQuestion) return;
      if (explanationBox.style.display === "none") {
        explanationBox.innerHTML = currentQuestion.explanation
          ? currentQuestion.explanation.replace(/\n/g, "<br>")
          : "解説は登録されていません。";
        explanationBox.style.display = "block";
        explainBtn.textContent = "解説を閉じる";
      } else {
        explanationBox.style.display = "none";
        explainBtn.textContent = "解説を見る";
      }
    }

    // ====== イベント設定 ======
    explainBtn.addEventListener("click", function() {
      toggleExplanation();
    });

    nextBtn.addEventListener("click", function() {
      showNextQuestion();
    });

    // ====== ページ表示時に自動読み込み ======
    window.addEventListener("load", function() {
      storageKey = makeStorageKey(DEFAULT_CSV_URL);
      loadProgress();
      loadCsvFromUrl(DEFAULT_CSV_URL);
    });
  </script>
</body>
</html>
